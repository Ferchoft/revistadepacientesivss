<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistema de Registro Hospitalario</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --danger: #f72585;
      --success: #4cc9f0;
      --whatsapp: #25D366;
      --telegram: #0088cc;
      --email: #EA4335;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --card-bg: #ffffff;
      --border: #dee2e6;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 8px;
      --transition: all 0.3s ease;
    }

    /* Tema oscuro */
    [data-theme="dark"] {
      --light: #121212;
      --dark: #e0e0e0;
      --card-bg: #1e1e1e;
      --border: #333;
      --gray: #aaa;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
      position: relative;
    }

    .admin-logo {
      position: absolute;
      left: 20px;
      top: 20px;
      max-width: 80px;
      max-height: 80px;
      object-fit: contain;
    }

    @media (max-width: 768px) {
      .admin-logo {
        position: static;
        margin-bottom: 15px;
      }
    }

    h1 {
      font-size: 2.2rem;
      color: var(--primary);
      margin-bottom: 10px;
      background: linear-gradient(45deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Estilos para el sistema de login */
    .login-container {
      max-width: 400px;
      margin: 50px auto;
      padding: 30px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
    }
    
    .login-container h2 {
      margin-bottom: 20px;
      color: var(--primary);
    }
    
    .login-form .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    
    .login-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    .login-form input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background-color: var(--card-bg);
      color: var(--dark);
    }
    
    .login-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .login-btn:hover {
      background: var(--primary-dark);
    }
    
    .hidden {
      display: none;
    }
    
    .user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--card-bg);
      padding: 10px 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }

    .header-lines {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .header-line {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: var(--transition);
      background-color: var(--card-bg);
      color: var(--dark);
    }

    .header-line:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.25);
    }

    .header-line-1 {
      font-size: 1.1rem;
      font-weight: bold;
    }

    .header-line-2 {
      font-size: 0.95rem;
    }

    .header-line-3 {
      font-size: 0.85rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      transition: var(--transition);
      background-color: var(--card-bg);
      color: var(--dark);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.25);
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    .span-2 {
      grid-column: span 2;
    }

    .logo-upload-container {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .logo-upload-box {
      flex: 1;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .logo-upload-box:hover {
      border-color: var(--accent);
      background-color: rgba(72, 149, 239, 0.05);
    }

    .logo-preview {
      max-width: 80px;
      max-height: 80px;
      margin-top: 8px;
      display: none;
    }

    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 25px;
      justify-content: center;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #3aa8d4;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-whatsapp {
      background: var(--whatsapp);
      color: white;
    }

    .btn-telegram {
      background: var(--telegram);
      color: white;
    }

    .btn-email {
      background: var(--email);
      color: white;
    }

    .table-responsive {
      overflow-x: auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0;
      margin-bottom: 25px;
    }

    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .pdf-table th {
      background: var(--primary);
      color: white;
      padding: 8px 6px;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .pdf-table td {
      padding: 6px;
      text-align: center;
      border: 1px solid var(--border);
      vertical-align: middle;
    }

    .pdf-table tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .pdf-table tr:hover {
      background-color: rgba(72, 149, 239, 0.1);
    }

    .action-cell {
      display: flex;
      justify-content: center;
      gap: 5px;
    }

    .action-btn {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .edit-btn {
      background: var(--accent);
      color: white;
    }

    .delete-btn {
      background: var(--danger);
      color: white;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: var(--radius);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: var(--danger);
    }

    .share-menu {
      position: relative;
      display: inline-block;
    }
    
    .share-options {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 8px;
      z-index: 100;
      min-width: 160px;
    }
    
    .share-menu:hover .share-options {
      display: block;
    }
    
    .share-option {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      margin: 2px 0;
      font-size: 0.85rem;
    }
    
    .share-option:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .share-option i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
    }
    
    .whatsapp-option { color: var(--whatsapp); }
    .telegram-option { color: var(--telegram); }
    .email-option { color: var(--email); }

    .empty-table {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-style: italic;
    }

    /* Estilos mejorados para el formulario de registro */
    .register-form {
      display: none;
      margin-top: 25px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      animation: fadeIn 0.3s ease;
      border: 1px solid rgba(72, 149, 239, 0.2);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .register-form.show {
      display: block;
    }

    .register-form h3 {
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.3rem;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
    }

    .register-form .form-group {
      margin-bottom: 18px;
    }

    .register-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .register-form input,
    .register-form select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      transition: var(--transition);
      background-color: var(--card-bg);
      color: var(--dark);
    }

    .register-form input:focus,
    .register-form select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.15);
    }

    .register-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .register-buttons .btn {
      flex: 1;
      padding: 12px;
    }

    /* Estilo especial para el select de servicios */
    #register-service {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 36px;
    }

    /* Estilos para el panel de administración */
    .admin-panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .admin-table th {
      background: var(--primary);
      color: white;
      padding: 8px 6px;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .admin-table td {
      padding: 6px;
      text-align: center;
      border: 1px solid var(--border);
      vertical-align: middle;
    }

    .admin-table tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .admin-table tr:hover {
      background-color: rgba(72, 149, 239, 0.1);
    }

    .service-badge {
      background: var(--accent);
      color: white;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .admin-badge {
      background: var(--danger);
      color: white;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .admin-container {
      display: none;
    }

    .admin-container.show {
      display: block;
    }

    .service-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .service-tab {
      padding: 8px 16px;
      background: var(--card-bg);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: var(--transition);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .service-tab:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .service-tab.active {
      background: var(--primary);
      color: white;
    }

    .service-content {
      display: none;
    }

    .service-content.active {
      display: block;
    }

    .remember-me {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .remember-me input {
      width: auto;
    }

    /* Carrusel de imágenes */
    .carousel {
      position: relative;
      width: 100%;
      height: 200px;
      overflow: hidden;
      border-radius: var(--radius);
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .carousel-inner {
      display: flex;
      width: 500%;
      height: 100%;
      transition: transform 0.5s ease;
    }

    .carousel-item {
      width: 20%;
      height: 100%;
      flex-shrink: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .carousel-item img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .carousel-controls {
      position: absolute;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .carousel-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .carousel-indicator.active {
      background-color: white;
    }

    /* Nuevo diseño para panel administrativo */
    .admin-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .admin-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      cursor: pointer;
    }

    .admin-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .admin-card h3 {
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .admin-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 10px;
    }

    .admin-card .description {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .admin-card .icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(72, 149, 239, 0.1);
      color: var(--primary);
    }

    .admin-section {
      margin-bottom: 30px;
    }

    .admin-section-title {
      font-size: 1.3rem;
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
    }

    .admin-register-form {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .admin-register-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    /* Login de administrador */
    .admin-login-btn {
      width: 100%;
      padding: 12px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }

    .admin-login-btn:hover {
      background: #d61a6f;
    }

    /* Búsqueda */
    .search-container {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background-color: var(--card-bg);
      color: var(--dark);
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tema toggle */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 1000;
    }

    /* Modal para login de administrador */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 400px;
      box-shadow: var(--shadow);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--dark);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Modal para lista de médicos */
    .doctors-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .doctors-modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .doctors-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .doctors-modal-title {
      font-size: 1.3rem;
      color: var(--primary);
      font-weight: bold;
    }

    .close-doctors-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--dark);
    }

    .doctors-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .doctors-table th {
      background: var(--primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .doctors-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    .doctors-table tr:hover {
      background-color: rgba(72, 149, 239, 0.1);
    }

    .doctor-actions {
      display: flex;
      gap: 5px;
    }

    .suspend-btn {
      background: #ffc107;
      color: #212529;
    }

    /* Modal para pacientes activos */
    .patients-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .patients-modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .patients-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .patients-modal-title {
      font-size: 1.3rem;
      color: var(--primary);
      font-weight: bold;
    }

    .close-patients-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--dark);
    }

    .patients-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .patients-table th {
      background: var(--primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .patients-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    .patients-table tr:hover {
      background-color: rgba(72, 149, 239, 0.1);
    }

    .patient-actions {
      display: flex;
      gap: 5px;
    }

    /* Modal para servicios activos */
    .services-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .services-modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .services-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .services-modal-title {
      font-size: 1.3rem;
      color: var(--primary);
      font-weight: bold;
    }

    .close-services-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--dark);
    }

    .services-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .services-table th {
      background: var(--primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .services-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    .services-table tr:hover {
      background-color: rgba(72, 149, 239, 0.1);
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .span-2 {
        grid-column: span 1;
      }
      
      .logo-upload-container {
        flex-direction: column;
      }
      
      .btn-container {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }

      .share-options {
        left: 0;
        transform: translateX(0);
      }
      
      .user-info {
        position: static;
        margin-bottom: 20px;
        justify-content: center;
      }

      .register-form {
        padding: 20px 15px;
      }

      .register-buttons {
        flex-direction: column;
      }

      .register-buttons .btn {
        width: 100%;
      }

      #register-service {
        width: 100%;
      }

      .service-tabs {
        overflow-x: auto;
        padding-bottom: 10px;
        flex-wrap: nowrap;
      }

      .admin-dashboard {
        grid-template-columns: 1fr;
      }

      .carousel {
        height: 150px;
      }

      .doctors-table {
        display: block;
        overflow-x: auto;
      }

      .doctor-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<!-- Contenedor de login -->
<div class="login-container" id="login-container">
<h2>Acceso Médico</h2>
<form class="login-form" id="login-form">
<div class="form-group">
<label for="email">Correo electrónico</label>
<input id="email" required="" type="email"/>
</div>
<div class="form-group">
<label for="password">Contraseña</label>
<input id="password" required="" type="text"/>
</div>
<div class="remember-me">
<input id="remember-me" type="checkbox"/>
<label for="remember-me">Recordar mis datos</label>
</div>
<button class="login-btn" type="submit">Iniciar sesión</button>
</form>
<div style="margin-top: 20px;">
<button class="admin-login-btn" id="admin-login-btn">
<i class="fas fa-user-shield"></i> Administrador
      </button>
</div>
</div>
<!-- Modal para login de administrador -->
<div class="modal" id="admin-login-modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">Administrador</div>
<button class="close-modal">×</button>
</div>
<div class="modal-body">
<div class="form-group">
<label for="admin-email">Correo electrónico</label>
<input class="form-control" id="admin-email" required="" type="email"/>
</div>
<div class="form-group">
<label for="admin-password">Contraseña</label>
<input class="form-control" id="admin-password" required="" type="text"/>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-danger" id="cancel-admin-login">Cancelar</button>
<button class="btn btn-success" id="confirm-admin-login">Ingresar</button>
</div>
</div>
</div>
<!-- Contenido principal (oculto inicialmente) -->
<div class="container hidden" id="main-container">
<div class="user-info">
<span id="current-user"></span>
<span class="service-badge" id="current-service"></span>
<button class="logout-btn" id="logout-btn">Salir</button>
</div>
<!-- Carrusel de imágenes -->
<header>
<h1>Registro de Pacientes</h1>
<p>Sistema de gestión hospitalaria</p>
</header>
<!-- Carrusel de imágenes (reemplazado por banner de video) -->
<div class="carousel" style="height: auto;">
<iframe allow="accelerometer; autoplay; clipboard-write; 
          encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/IFOyfaKJzvw?autoplay=1&amp;mute=1" style="border-radius: var(--radius); box-shadow: var(--shadow);" title="YouTube video player" width="100%"></iframe>
</div>
<div class="panel">
<div class="header-lines">
<input class="header-line header-line-1" id="header-line-1" placeholder="Línea 1 (ej: REPÚBLICA BOLIVARIANA DE VENEZUELA)" type="text"/>
<input class="header-line header-line-2" id="header-line-2" placeholder="Línea 2 (ej: HOSPITAL GENERAL)" type="text"/>
<input class="header-line header-line-3" id="header-line-3" placeholder="Línea 3 (ej: POSTGRADO DE PEDIATRÍA Y PUERICULTURA)" type="text"/>
<input class="header-line header-line-3" id="header-line-4" placeholder="Línea 4 (ej: SAN CRISTOBAL - EDO-TÁCHIRA)" type="text"/>
</div>
<div class="logo-upload-container">
<div class="logo-upload-box" onclick="document.getElementById('left-logo').click()">
<i class="fas fa-image fa-2x"></i>
<p>Logo Izquierdo</p>
<input accept="image/*" id="left-logo" style="display:none" type="file"/>
<img class="logo-preview" id="left-logo-preview"/>
</div>
<div class="logo-upload-box" onclick="document.getElementById('right-logo').click()">
<i class="fas fa-image fa-2x"></i>
<p>Logo Derecho</p>
<input accept="image/*" id="right-logo" style="display:none" type="file"/>
<img class="logo-preview" id="right-logo-preview"/>
</div>
</div>
</div>
<!-- Búsqueda -->
<div class="search-container panel">
<input class="search-input" id="search-input" placeholder="Buscar pacientes..." type="text"/>
</div>
<form class="panel" id="patient-form">
<div class="form-grid">
<div class="form-group">
<label for="location">Ubicación</label>
<input class="form-control" id="location" required="" type="text"/>
</div>
<div class="form-group">
<label for="bed">Cama</label>
<input class="form-control" id="bed" required="" type="text"/>
</div>
<div class="form-group">
<label for="record">HC</label>
<input class="form-control" id="record" required="" type="text"/>
</div>
<div class="form-group">
<label for="patient">Paciente</label>
<input class="form-control" id="patient" required="" type="text"/>
</div>
<div class="form-group">
<label for="age">Edad</label>
<input class="form-control" id="age" max="120" min="0" required="" type="number"/>
</div>
<div class="form-group">
<label for="admission">Fecha Ingreso</label>
<input class="form-control" id="admission" required="" type="datetime-local"/>
</div>
<div class="form-group">
<label for="dh">DH</label>
<input class="form-control" id="dh" required="" type="text"/>
</div>
<div class="form-group span-2">
<label for="diagnosis">Diagnóstico</label>
<textarea class="form-control" id="diagnosis" required=""></textarea>
</div>
<div class="form-group">
<label for="attachment">Adjunto</label>
<input class="form-control" id="attachment" required="" type="text"/>
</div>
<div class="form-group span-2">
<label for="plan">Plan</label>
<textarea class="form-control" id="plan" required=""></textarea>
</div>
</div>
</form>
<div class="btn-container">
<button class="btn btn-success" id="add-btn">
<i class="fas fa-plus"></i> Agregar
      </button>
<button class="btn btn-primary" id="pdf-btn">
<i class="fas fa-file-pdf"></i> PDF
      </button>
<button class="btn btn-primary" id="preview-btn">
<i class="fas fa-eye"></i> Vista Previa
      </button>
<button class="btn btn-success" id="excel-btn">
<i class="fas fa-file-excel"></i> Excel
      </button>
<div class="share-menu">
<button class="btn btn-primary">
<i class="fas fa-share-alt"></i> Compartir
        </button>
<div class="share-options">
<div class="share-option whatsapp-option" id="share-whatsapp">
<i class="fab fa-whatsapp"></i> WhatsApp
          </div>
<div class="share-option telegram-option" id="share-telegram">
<i class="fab fa-telegram"></i> Telegram
          </div>
<div class="share-option email-option" id="share-email">
<i class="fas fa-envelope"></i> Correo
          </div>
</div>
</div>
<button class="btn btn-danger" id="clear-btn">
<i class="fas fa-trash"></i> Limpiar
      </button>
</div>
<div class="table-responsive">
<table class="pdf-table">
<thead>
<tr>
<th>Ubicación</th>
<th>Cama</th>
<th>HC</th>
<th>Paciente</th>
<th>Edad</th>
<th>Ingreso</th>
<th>DH</th>
<th>Diagnóstico</th>
<th>Adjunto</th>
<th>Plan</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="patients-table">
<!-- Datos dinámicos -->
</tbody>
</table>
</div>
</div>
<!-- Panel de administración (oculto inicialmente) -->
<div class="container hidden" id="admin-container">
<div class="user-info">
<span id="admin-current-user"></span>
<span class="admin-badge">Administrador</span>
<button class="logout-btn" id="admin-logout-btn">Salir</button>
</div>
<header>
<img alt="Logo Hospital" class="admin-logo" src="https://raw.githubusercontent.com/Ferchoft/revistadepacientesivss/refs/heads/main/Imagen1.png"/>
<h1>Panel de Administración</h1>
<p>Gestión integral del sistema hospitalario</p>
</header>
<!-- Carrusel de imágenes (reemplazado por banner de video) -->
<div class="carousel" style="height: auto;">
<iframe allow="accelerometer; autoplay; clipboard-write; 
          encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/IFOyfaKJzvw?autoplay=1&amp;mute=1" style="border-radius: var(--radius); box-shadow: var(--shadow);" title="YouTube video player" width="100%"></iframe>
</div>
<div class="admin-panel">
<!-- Dashboard de estadísticas -->
<div class="admin-dashboard" id="admin-dashboard">
<!-- Estadísticas dinámicas -->
</div>
<!-- Sección de registro de nuevos médicos -->
<div class="admin-section">
<h2 class="admin-section-title">
<i class="fas fa-user-plus"></i> Registrar Nuevo Médico
        </h2>
<div class="admin-register-form">
<div class="admin-register-grid">
<div class="form-group">
<label for="admin-register-email">Correo electrónico</label>
<input class="form-control" id="admin-register-email" required="" type="email"/>
</div>
<div class="form-group">
<label for="admin-register-password">Contraseña</label>
<input class="form-control" id="admin-register-password" minlength="6" required="" type="text"/>
</div>
<div class="form-group">
<label for="admin-register-service">Servicio Médico</label>
<select class="form-control" id="admin-register-service" required="">
<option value="">Seleccione un servicio</option>
<option value="pediatria">Pediatría</option>
<option value="anestesiologia">Anestesiología</option>
<option value="traumatologia">Traumatología</option>
<option value="oftalmologia">Oftalmología</option>
<option value="gastroenterologia">Gastroenterología</option>
<option value="oncologia">Oncología</option>
<option value="dermatologia">Dermatología</option>
<option value="medicina_interna">Medicina Interna</option>
<option value="cirugia">Cirugía</option>
<option value="ginecologia">Ginecología</option>
<option value="radiologia">Radiología</option>
<option value="neurologia">Neurología</option>
<option value="cardiologia">Cardiología</option>
</select>
</div>
<div class="form-group"><label for="admin-register-phone">Teléfono</label><input class="form-control" id="admin-register-phone" required="" type="tel"/></div><div class="form-group" style="align-self: flex-end;">
<button class="btn btn-success" id="admin-register-btn">
<i class="fas fa-save"></i> Registrar Médico
              </button>
</div>
</div>
</div>
</div>
<!-- Sección de gestión de pacientes -->
<div class="admin-section">
<h2 class="admin-section-title">
<i class="fas fa-procedures"></i> Gestión de Pacientes
        </h2>
<div class="service-tabs" id="service-tabs">
<!-- Tabs dinámicos -->
</div>
<div id="service-contents">
<!-- Contenido dinámico por servicio -->
</div>
</div>
<div class="btn-container">
<button class="btn btn-primary" id="admin-word-btn"><i class="fas fa-file-word"></i> Word</button><button class="btn btn-primary" id="admin-preview-btn">
<i class="fas fa-eye"></i> Vista Previa
        </button>
<button class="btn btn-primary" id="admin-pdf-btn">
<i class="fas fa-file-pdf"></i> PDF
        </button>
<button class="btn btn-success" id="admin-excel-btn">
<i class="fas fa-file-excel"></i> Excel
        </button>
<div class="share-menu">
<button class="btn btn-primary">
<i class="fas fa-share-alt"></i> Compartir
          </button>
<div class="share-options">
<div class="share-option whatsapp-option" id="admin-share-whatsapp">
<i class="fab fa-whatsapp"></i> WhatsApp
            </div>
<div class="share-option telegram-option" id="admin-share-telegram">
<i class="fab fa-telegram"></i> Telegram
            </div>
<div class="share-option email-option" id="admin-share-email">
<i class="fas fa-envelope"></i> Correo
            </div>
</div>
</div>
</div>
</div>
</div>
<!-- Modal para lista de médicos -->
<div class="doctors-modal" id="doctors-modal">
<div class="doctors-modal-content">
<div class="doctors-modal-header">
<div class="doctors-modal-title">Médicos Registrados</div>
<button class="close-doctors-modal">×</button>
</div>
<table class="doctors-table">
<thead>
<tr>
<th>Correo Electrónico</th>
<th>Servicio</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="doctors-list">
<!-- Datos dinámicos -->
</tbody>
</table>
</div>
</div>
<!-- Modal para lista de pacientes activos -->
<div class="patients-modal" id="patients-modal">
<div class="patients-modal-content">
<div class="patients-modal-header">
<div class="patients-modal-title">Pacientes Activos</div>
<button class="close-patients-modal">×</button>
</div>
<table class="patients-table">
<thead>
<tr>
<th>Ubicación</th>
<th>Cama</th>
<th>HC</th>
<th>Paciente</th>
<th>Edad</th>
<th>Ingreso</th>
<th>DH</th>
<th>Diagnóstico</th>
<th>Adjunto</th>
<th>Plan</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="patients-list">
<!-- Datos dinámicos -->
</tbody>
</table>
</div>
</div>
<!-- Modal para lista de servicios activos -->
<div class="services-modal" id="services-modal">
<div class="services-modal-content">
<div class="services-modal-header">
<div class="services-modal-title">Servicios Activos</div>
<button class="close-services-modal">×</button>
</div>
<table class="services-table">
<thead>
<tr>
<th>Servicio</th>
<th>Pacientes</th>
<th>Médicos</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="services-list">
<!-- Datos dinámicos -->
</tbody>
</table>
</div>
</div>
<div class="notification" id="notification"></div>
<!-- Botón para cambiar tema -->
<button class="theme-toggle" id="theme-toggle">
<i class="fas fa-moon"></i>
</button>
<!-- SheetJS para exportar a Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBriVI3jSjiWtZgb7ly6ch1OqRhLlIRVJI",
      authDomain: "chat-medicall.firebaseapp.com",
      databaseURL: "https://chat-medicall-default-rtdb.firebaseio.com",
      projectId: "chat-medicall",
      storageBucket: "chat-medicall.appspot.com",
      messagingSenderId: "1006178284249",
      appId: "1:1006178284249:web:748369f4c205904e9244c8",
      measurementId: "G-163KG5XQJN"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Configuración de la aplicación
    const DEFAULT_LEFT_LOGO_URL = 'https://raw.githubusercontent.com/Ferchoft/revistadepacientesivss/refs/heads/main/Imagen1.png';
    const DEFAULT_RIGHT_LOGO_URL = 'https://raw.githubusercontent.com/Ferchoft/revistadepacientesivss/refs/heads/main/Imagen2.png';
    
    let config = {
      headerLine1: 'REPÚBLICA BOLIVARIANA DE VENEZUELA',
      headerLine2: 'HOSPITAL IVSS "DR. PATROCINIO PEÑUELA RUIZ"',
      headerLine3: '',
      headerLine4: 'SAN CRISTÓBAL, ESTADO TÁCHIRA',
      leftLogo: DEFAULT_LEFT_LOGO_URL,
      rightLogo: DEFAULT_RIGHT_LOGO_URL
    };
    
    let patients = [];
    let allPatients = {};
    let editingIndex = null;
    let currentService = null;
    let isAdmin = false;
    let services = [
      'pediatria', 'anestesiologia', 'traumatologia', 'oftalmologia',
      'gastroenterologia', 'oncologia', 'dermatologia', 'medicina_interna',
      'cirugia', 'ginecologia', 'radiologia', 'neurologia', 'cardiologia'
    ];
    let lastPatientCount = 0;
    let currentPatientId = null;
    let carouselInterval;
    let doctors = [];

    // Elementos DOM
    const loginContainer = document.getElementById('login-container');
    const mainContainer = document.getElementById('main-container');
    const adminContainer = document.getElementById('admin-container');
    const loginForm = document.getElementById('login-form');
    const currentUserSpan = document.getElementById('current-user');
    const adminCurrentUserSpan = document.getElementById('admin-current-user');
    const currentServiceSpan = document.getElementById('current-service');
    const logoutBtn = document.getElementById('logout-btn');
    const adminLogoutBtn = document.getElementById('admin-logout-btn');
    const headerLine1 = document.getElementById('header-line-1');
    const headerLine2 = document.getElementById('header-line-2');
    const headerLine3 = document.getElementById('header-line-3');
    const headerLine4 = document.getElementById('header-line-4');
    const leftLogoInput = document.getElementById('left-logo');
    const rightLogoInput = document.getElementById('right-logo');
    const leftLogoPreview = document.getElementById('left-logo-preview');
    const rightLogoPreview = document.getElementById('right-logo-preview');
    const patientForm = document.getElementById('patient-form');
    const patientsTable = document.getElementById('patients-table');
    const serviceTabs = document.getElementById('service-tabs');
    const serviceContents = document.getElementById('service-contents');
    const adminDashboard = document.getElementById('admin-dashboard');
    const addBtn = document.getElementById('add-btn');
    const pdfBtn = document.getElementById('pdf-btn');
    const previewBtn = document.getElementById('preview-btn');
    const excelBtn = document.getElementById('excel-btn');
    const adminPdfBtn = document.getElementById('admin-pdf-btn');
    const adminPreviewBtn = document.getElementById('admin-preview-btn');
    const adminExcelBtn = document.getElementById('admin-excel-btn');
    const clearBtn = document.getElementById('clear-btn');
    const notification = document.getElementById('notification');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const searchInput = document.getElementById('search-input');
    const themeToggle = document.getElementById('theme-toggle');
    const adminLoginBtn = document.getElementById('admin-login-btn');
    const adminLoginModal = document.getElementById('admin-login-modal');
    const closeModalBtn = document.querySelector('.close-modal');
    const cancelAdminLoginBtn = document.getElementById('cancel-admin-login');
    const confirmAdminLoginBtn = document.getElementById('confirm-admin-login');
    const adminEmailInput = document.getElementById('admin-email');
    const adminPasswordInput = document.getElementById('admin-password');
    const adminRegisterEmail = document.getElementById('admin-register-email');
    const adminRegisterPassword = document.getElementById('admin-register-password');
    const adminRegisterService = document.getElementById('admin-register-service');
    const adminRegisterBtn = document.getElementById('admin-register-btn');
    const carouselInner = document.getElementById('carousel-inner');
    const carouselIndicators = document.querySelectorAll('.carousel-indicator');
    const doctorsModal = document.getElementById('doctors-modal');
    const closeDoctorsModalBtn = document.querySelector('.close-doctors-modal');
    const doctorsList = document.getElementById('doctors-list');
    const patientsModal = document.getElementById('patients-modal');
    const closePatientsModalBtn = document.querySelector('.close-patients-modal');
    const patientsList = document.getElementById('patients-list');
    const servicesModal = document.getElementById('services-modal');
    const closeServicesModalBtn = document.querySelector('.close-services-modal');
    const servicesList = document.getElementById('services-list');

    // Mostrar notificación
    function showNotification(message, type = 'success', duration = 3000) {
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // Iniciar carrusel
    function startCarousel() {
      let currentIndex = 0;
      const items = document.querySelectorAll('.carousel-item');
      const indicators = document.querySelectorAll('.carousel-indicator');
      
      function updateCarousel() {
        carouselInner.style.transform = `translateX(-${currentIndex * 100}%)`;
        
        indicators.forEach((indicator, index) => {
          indicator.classList.toggle('active', index === currentIndex);
        });
        
        currentIndex = (currentIndex + 1) % items.length;
      }
      
      // Configurar intervalo para cambio automático
      clearInterval(carouselInterval);
      carouselInterval = setInterval(updateCarousel, 2000);
      
      // Event listeners para controles manuales
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
          clearInterval(carouselInterval);
          currentIndex = index;
          updateCarousel();
          carouselInterval = setInterval(updateCarousel, 2000);
        });
      });
    }

    // Cargar médicos registrados
    async function loadDoctors() {
      try {
        const snapshot = await db.collection('users').get();
        doctors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAdminDashboard();
      } catch (error) {
        console.error('Error al cargar médicos:', error);
        showNotification('Error al cargar médicos', 'error');
      }
    }

    // Mostrar modal de médicos
    function showDoctorsModal() {
      doctorsList.innerHTML = '';
      
      if (doctors.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.textContent = 'No hay médicos registrados';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        doctorsList.appendChild(row);
        return;
      }
      
      doctors.forEach(doctor => {
        const row = document.createElement('tr');
        
        const emailCell = document.createElement('td');
        emailCell.textContent = doctor.email;
        row.appendChild(emailCell);
        
        const serviceCell = document.createElement('td');
        const phoneCell = document.createElement("td");
        phoneCell.textContent = doctor.phone || "Sin teléfono";
        row.appendChild(phoneCell);
        serviceCell.textContent = doctor.services ? doctor.services.join(', ') : 'Sin servicio';
        row.appendChild(serviceCell);
        
        const statusCell = document.createElement('td');
        statusCell.textContent = doctor.disabled ? 'Suspendido' : 'Activo';
        row.appendChild(statusCell);
        
        const actionsCell = document.createElement('td');
        actionsCell.className = 'doctor-actions';
        actionsCell.innerHTML = `
          <button onclick="editDoctor('${doctor.id}')" class="action-btn edit-btn">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button onclick="toggleDoctorStatus('${doctor.id}', ${!doctor.disabled})" class="action-btn suspend-btn">
            <i class="fas ${doctor.disabled ? 'fa-check-circle' : 'fa-ban'}"></i> ${doctor.disabled ? 'Activar' : 'Suspender'}
          </button>
          <button onclick="deleteDoctor('${doctor.id}')" class="action-btn delete-btn">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        `;
        row.appendChild(actionsCell);
        
        doctorsList.appendChild(row);
      });
      
      doctorsModal.style.display = 'flex';
    }

    // Mostrar modal de pacientes activos
    function showPatientsModal() {
      patientsList.innerHTML = '';
      
      let totalPatients = 0;
      const allPatientsList = [];
      
      services.forEach(service => {
        if (allPatients[service] && allPatients[service].length > 0) {
          allPatients[service].forEach(patient => {
            patient.service = service;
            allPatientsList.push(patient);
          });
          totalPatients += allPatients[service].length;
        }
      });
      
      if (totalPatients === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 11;
        cell.textContent = 'No hay pacientes activos';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        patientsList.appendChild(row);
        return;
      }
      
      allPatientsList.forEach((patient, index) => {
        const row = document.createElement('tr');
        
        ['location', 'bed', 'record', 'patient', 'age', 'admission', 'dh', 'diagnosis', 'attachment', 'plan'].forEach(field => {
          const cell = document.createElement('td');
          cell.textContent = patient[field] || '-';
          cell.style.whiteSpace = 'pre-wrap';
          row.appendChild(cell);
        });
        
        const serviceCell = document.createElement('td');
        serviceCell.textContent = patient.service;
        row.appendChild(serviceCell);
        
        const actionsCell = document.createElement('td');
        actionsCell.className = 'patient-actions';
        actionsCell.innerHTML = `
          <button onclick="editPatientAdmin('${patient.service}', ${index})" class="action-btn edit-btn">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button onclick="deletePatientAdmin('${patient.service}', ${index})" class="action-btn delete-btn">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        `;
        row.appendChild(actionsCell);
        
        patientsList.appendChild(row);
      });
      
      patientsModal.style.display = 'flex';
    }

    // Mostrar modal de servicios activos
    function showServicesModal() {
      servicesList.innerHTML = '';
      
      let activeServicesCount = 0;
      
      services.forEach(service => {
        const patientsCount = allPatients[service] ? allPatients[service].length : 0;
        if (patientsCount > 0) {
          activeServicesCount++;
          
          const doctorsCount = doctors.filter(d => d.services && d.services.includes(service)).length;
          
          const row = document.createElement('tr');
          
          const serviceCell = document.createElement('td');
          serviceCell.textContent = service.charAt(0).toUpperCase() + service.slice(1);
          row.appendChild(serviceCell);
          
          const patientsCell = document.createElement('td');
          patientsCell.textContent = patientsCount;
          row.appendChild(patientsCell);
          
          const doctorsCell = document.createElement('td');
          doctorsCell.textContent = doctorsCount;
          row.appendChild(doctorsCell);
          
          const actionsCell = document.createElement('td');
          actionsCell.className = 'patient-actions';
          actionsCell.innerHTML = `
            <button onclick="viewServicePatients('${service}')" class="action-btn edit-btn">
              <i class="fas fa-eye"></i> Ver
            </button>
          `;
          row.appendChild(actionsCell);
          
          servicesList.appendChild(row);
        }
      });
      
      if (activeServicesCount === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.textContent = 'No hay servicios activos';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        servicesList.appendChild(row);
      }
      
      servicesModal.style.display = 'flex';
    }

    // Ver pacientes de un servicio específico
    window.viewServicePatients = function(service) {
      servicesModal.style.display = 'none';
      
      // Activar la pestaña del servicio
      document.querySelectorAll('.service-tab').forEach(tab => {
        if (tab.dataset.service === service) {
          tab.click();
        }
      });
    };

    // Editar médico
    window.editDoctor = function(doctorId) {
      const doctor = doctors.find(d => d.id === doctorId);
      if (!doctor) return;
      
      adminRegisterEmail.value = doctor.email;
      adminRegisterService.value = doctor.services ? doctor.services[0] : '';
      
      // Cambiar texto del botón a "Actualizar"
      adminRegisterBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar';
      adminRegisterBtn.dataset.doctorId = doctorId;
      
      showNotification('Complete los campos y presione Actualizar para guardar los cambios');
    };

    // Cambiar estado de médico (suspender/activar)
    window.toggleDoctorStatus = async function(doctorId, suspend) {
      if (confirm(`¿Está seguro que desea ${suspend ? 'suspender' : 'activar'} esta cuenta?`)) {
        try {
          await db.collection('users').doc(doctorId).update({
            disabled: suspend,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Actualizar lista de médicos
          await loadDoctors();
          showNotification(`Cuenta ${suspend ? 'suspendida' : 'activada'} correctamente`);
        } catch (error) {
          console.error('Error al cambiar estado:', error);
          showNotification('Error al cambiar estado', 'error');
        }
      }
    };

    // Eliminar médico
    window.deleteDoctor = async function(doctorId) {
      if (confirm('¿Está seguro que desea eliminar este médico? Esta acción no se puede deshacer.')) {
        try {
          // Primero eliminamos el usuario de Authentication
          const doctor = doctors.find(d => d.id === doctorId);
          if (doctor) {
            await auth.deleteUser(doctorId);
          }
          
          // Luego eliminamos el registro de Firestore
          await db.collection('users').doc(doctorId).delete();
          
          // Actualizar lista de médicos
          await loadDoctors();
          showNotification('Médico eliminado correctamente');
        } catch (error) {
          console.error('Error al eliminar médico:', error);
          showNotification('Error al eliminar médico', 'error');
        }
      }
    };

    // Cargar configuración del servicio desde Firestore
    async function loadConfig(service) {
      try {
        const doc = await db.collection('services').doc(service).get();
        if (doc.exists) {
          config = doc.data().config;
          // Establecer valores predeterminados si no existen
          config.headerLine1 = config.headerLine1 || 'REPÚBLICA BOLIVARIANA DE VENEZUELA';
          config.headerLine2 = config.headerLine2 || `HOSPITAL IVSS "DR. PATROCINIO PEÑUELA RUIZ" - ${service.toUpperCase()}`;
          config.headerLine3 = config.headerLine3 || '';
          config.headerLine4 = config.headerLine4 || 'SAN CRISTÓBAL, ESTADO TÁCHIRA';
          config.leftLogo = config.leftLogo || DEFAULT_LEFT_LOGO_URL;
          config.rightLogo = config.rightLogo || DEFAULT_RIGHT_LOGO_URL;
          
          // Actualizar campos en la UI
          headerLine1.value = config.headerLine1;
          headerLine2.value = config.headerLine2;
          headerLine3.value = config.headerLine3;
          headerLine4.value = config.headerLine4;
          
          // Actualizar logos
          leftLogoPreview.src = config.leftLogo;
          leftLogoPreview.style.display = 'block';
          rightLogoPreview.src = config.rightLogo;
          rightLogoPreview.style.display = 'block';
        } else {
          // Crear configuración inicial si no existe
          config = {
            headerLine1: 'REPÚBLICA BOLIVARIANA DE VENEZUELA',
            headerLine2: `HOSPITAL IVSS "DR. PATROCINIO PEÑUELA RUIZ" - ${service.toUpperCase()}`,
            headerLine3: '',
            headerLine4: 'SAN CRISTÓBAL, ESTADO TÁCHIRA',
            leftLogo: DEFAULT_LEFT_LOGO_URL,
            rightLogo: DEFAULT_RIGHT_LOGO_URL
          };
          await db.collection('services').doc(service).set({ config });
        }
      } catch (error) {
        console.error('Error al cargar configuración:', error);
        showNotification('Error al cargar configuración', 'error');
      }
    }

    // Guardar configuración en Firestore
    async function saveConfig() {
      try {
        await db.collection('services').doc(currentService).update({ 
          config: {
            headerLine1: headerLine1.value,
            headerLine2: headerLine2.value,
            headerLine3: headerLine3.value,
            headerLine4: headerLine4.value,
            leftLogo: config.leftLogo,
            rightLogo: config.rightLogo
          }
        });
        showNotification('Configuración guardada');
      } catch (error) {
        console.error('Error al guardar configuración:', error);
        showNotification('Error al guardar configuración', 'error');
      }
    }

    // Cargar pacientes desde Firestore
    async function loadPatients() {
      try {
        const snapshot = await db.collection('services').doc(currentService).collection('patients').get();
        patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTable();
      } catch (error) {
        console.error('Error al cargar pacientes:', error);
        showNotification('Error al cargar pacientes', 'error');
      }
    }

    // Cargar TODOS los pacientes desde Firestore (para administrador)
    async function loadAllPatients() {
      try {
        allPatients = {};
        let totalPatients = 0;
        
        for (const service of services) {
          const snapshot = await db.collection('services').doc(service).collection('patients').get();
          allPatients[service] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          totalPatients += allPatients[service].length;
        }
        
        // Verificar si hay nuevos pacientes
        if (lastPatientCount > 0 && totalPatients > lastPatientCount) {
          showNotification(`Nuevos pacientes registrados: ${totalPatients - lastPatientCount}`, 'success');
        }
        lastPatientCount = totalPatients;
        
        renderAdminDashboard();
        renderAdminTabs();
        renderAdminContent();
      } catch (error) {
        console.error('Error al cargar todos los pacientes:', error);
        showNotification('Error al cargar todos los pacientes', 'error');
      }
    }

    // Renderizar dashboard de administración
    function renderAdminDashboard() {
      adminDashboard.innerHTML = '';
      
      // Calcular estadísticas
      let totalPatients = 0;
      let activeServices = 0;
      
      const serviceCounts = {};
      
      services.forEach(service => {
        const count = allPatients[service] ? allPatients[service].length : 0;
        totalPatients += count;
        if (count > 0) activeServices++;
        serviceCounts[service] = count;
      });
      
      // Tarjetas de dashboard
      const cards = [
        {
          title: 'Pacientes Activos',
          value: totalPatients,
          icon: 'fas fa-procedures',
          color: 'var(--primary)',
          description: 'Pacientes actualmente en el hospital',
          clickable: true,
          onClick: showPatientsModal
        },
        {
          title: 'Médicos Registrados',
          value: doctors.length,
          icon: 'fas fa-user-md',
          color: 'var(--success)',
          description: 'Profesionales médicos en el sistema',
          clickable: true,
          onClick: showDoctorsModal
        },
        {
          title: 'Servicios Activos',
          value: activeServices,
          icon: 'fas fa-clipboard-list',
          color: 'var(--danger)',
          description: 'Servicios médicos con pacientes',
          clickable: true,
          onClick: showServicesModal
        }
      ];
      
      // Crear tarjetas
      cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'admin-card';
        
        if (card.clickable) {
          cardElement.style.cursor = 'pointer';
          cardElement.addEventListener('click', card.onClick);
        }
        
        cardElement.innerHTML = `
          <h3>
            <div class="icon" style="background-color: ${card.color}20; color: ${card.color}">
              <i class="${card.icon}"></i>
            </div>
            ${card.title}
          </h3>
          <div class="value" style="color: ${card.color}">${card.value}</div>
          <div class="description">${card.description}</div>
        `;
        adminDashboard.appendChild(cardElement);
      });
    }

    // Renderizar tabs de servicios para administrador
    function renderAdminTabs() {
      serviceTabs.innerHTML = '';
      
      services.forEach((service, index) => {
        const count = allPatients[service] ? allPatients[service].length : 0;
        const tab = document.createElement('div');
        tab.className = `service-tab ${index === 0 ? 'active' : ''}`;
        tab.innerHTML = `
          <div>${service.charAt(0).toUpperCase() + service.slice(1)}</div>
          <div class="stat-value">${count}</div>
        `;
        tab.dataset.service = service;
        
        tab.addEventListener('click', () => {
          document.querySelectorAll('.service-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          document.querySelectorAll('.service-content').forEach(c => c.classList.remove('active'));
          document.getElementById(`content-${service}`).classList.add('active');
        });
        
        serviceTabs.appendChild(tab);
      });
    }

    // Renderizar contenido por servicio para administrador
    function renderAdminContent() {
      serviceContents.innerHTML = '';
      
      services.forEach((service, index) => {
        const content = document.createElement('div');
        content.className = `service-content ${index === 0 ? 'active' : ''}`;
        content.id = `content-${service}`;
        
        const table = document.createElement('table');
        table.className = 'admin-table';
        
        // Cabecera de la tabla
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>Ubicación</th>
            <th>Cama</th>
            <th>HC</th>
            <th>Paciente</th>
            <th>Edad</th>
            <th>Ingreso</th>
            <th>DH</th>
            <th>Diagnóstico</th>
            <th>Adjunto</th>
            <th>Plan</th>
            <th>Acciones</th>
          </tr>
        `;
        table.appendChild(thead);
        
        // Cuerpo de la tabla
        const tbody = document.createElement('tbody');
        
        if (!allPatients[service] || allPatients[service].length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 11;
          cell.className = 'empty-table';
          cell.textContent = 'No hay pacientes registrados en este servicio';
          row.appendChild(cell);
          tbody.appendChild(row);
        } else {
          allPatients[service].forEach((patient, index) => {
            const row = document.createElement('tr');
            
            ['location', 'bed', 'record', 'patient', 'age', 'admission', 'dh', 'diagnosis', 'attachment', 'plan'].forEach(field => {
              const cell = document.createElement('td');
              cell.textContent = patient[field] || '-';
              cell.style.whiteSpace = 'pre-wrap';
              row.appendChild(cell);
            });
            
            const actionsCell = document.createElement('td');
            actionsCell.className = 'action-cell';
            actionsCell.innerHTML = `
              <button onclick="editPatientAdmin('${service}', ${index})" class="action-btn edit-btn">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button onclick="deletePatientAdmin('${service}', ${index})" class="action-btn delete-btn">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            `;
            row.appendChild(actionsCell);
            tbody.appendChild(row);
          });
        }
        
        table.appendChild(tbody);
        content.appendChild(table);
        serviceContents.appendChild(content);
      });
    }

    // Renderizar tabla con filtrado
    function renderTable(filteredPatients = null) {
      patientsTable.innerHTML = '';
      
      const patientsToRender = filteredPatients || patients;
      
      if (patientsToRender.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 11;
        cell.className = 'empty-table';
        cell.textContent = filteredPatients ? 'No se encontraron pacientes' : 'No hay pacientes registrados';
        row.appendChild(cell);
        patientsTable.appendChild(row);
        return;
      }
      
      patientsToRender.forEach((patient, index) => {
        const row = document.createElement('tr');
        
        ['location', 'bed', 'record', 'patient', 'age', 'admission', 'dh', 'diagnosis', 'attachment', 'plan'].forEach(field => {
          const cell = document.createElement('td');
          cell.textContent = patient[field] || '-';
          cell.style.whiteSpace = 'pre-wrap';
          row.appendChild(cell);
        });
        
        const actionsCell = document.createElement('td');
        actionsCell.className = 'action-cell';
        actionsCell.innerHTML = `
          <button onclick="editPatient(${index})" class="action-btn edit-btn">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button onclick="deletePatient(${index})" class="action-btn delete-btn">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        `;
        row.appendChild(actionsCell);
        patientsTable.appendChild(row);
      });
    }

    // Filtrar pacientes
    function filterPatients(searchTerm) {
      if (!searchTerm) return patients;
      
      return patients.filter(patient => 
        (patient.patient && patient.patient.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (patient.record && patient.record.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (patient.location && patient.location.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (patient.diagnosis && patient.diagnosis.toLowerCase().includes(searchTerm.toLowerCase()))
      );
    }

    // Obtener datos del formulario
    function getFormData() {
      return {
        location: document.getElementById('location').value.trim(),
        bed: document.getElementById('bed').value.trim(),
        record: document.getElementById('record').value.trim(),
        patient: document.getElementById('patient').value.trim(),
        age: document.getElementById('age').value.trim(),
        admission: formatDate(document.getElementById('admission').value),
        dh: document.getElementById('dh').value.trim(),
        diagnosis: document.getElementById('diagnosis').value.trim(),
        attachment: document.getElementById('attachment').value.trim(),
        plan: document.getElementById('plan').value.trim(),
        updatedBy: auth.currentUser ? auth.currentUser.email : 'system',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
    }

    // Formatear fecha
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Cargar imagen
    function handleImageUpload(input, preview, configKey) {
      const file = input.files[0];
      if (!file) return;
      
      if (!file.type.match('image.*')) {
        showNotification('Solo se permiten imágenes', 'error');
        return;
      }
      
      if (file.size > 2 * 1024 * 1024) {
        showNotification('La imagen es demasiado grande (máx. 2MB)', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        config[configKey] = e.target.result;
        saveConfig();
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // Generar PDF
    async function generatePDF(service = null) {
      try {
        const { jsPDF } = window.jspdf || await loadJsPDF();
        
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm'
        });
        
        // Configuración del documento
        const margin = 10;
        const pageWidth = doc.internal.pageSize.getWidth();
        const centerX = pageWidth / 2;
        const logoSize = 15;
        const logoMarginTop = 10;
        const logoOffset = 80;
        
        // Logos - Solo si existen y son válidos
        try {
          if (config.leftLogo) {
            doc.addImage(config.leftLogo, 'PNG', centerX - logoOffset, logoMarginTop, logoSize, logoSize);
          }
        } catch (e) {
          console.warn('No se pudo cargar el logo izquierdo:', e);
        }
        
        try {
          if (config.rightLogo) {
            doc.addImage(config.rightLogo, 'PNG', centerX + logoOffset - logoSize, logoMarginTop, logoSize, logoSize);
          }
        } catch (e) {
          console.warn('No se pudo cargar el logo derecho:', e);
        }
        
        // Encabezado
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        
        doc.setFontSize(12);
        doc.text(config.headerLine1.toUpperCase(), centerX, logoMarginTop + 5, { align: 'center' });
        
        doc.setFontSize(10);
        doc.text(config.headerLine2.toUpperCase(), centerX, logoMarginTop + 10, { align: 'center' });
        
        doc.setFontSize(8);
        doc.text(config.headerLine3.toUpperCase(), centerX, logoMarginTop + 15, { align: 'center' });
        
        if (config.headerLine4) {
          doc.text(config.headerLine4.toUpperCase(), centerX, logoMarginTop + 20, { align: 'center' });
        }
        
        // Fecha generación
        const fechaHora = new Date().toLocaleString('es-ES');
        doc.setFontSize(7);
        doc.text(`Generado: ${fechaHora}`, pageWidth - margin - 2, logoMarginTop + 5, { align: 'right' });
        
        // Tabla
        const headers = [
          'UBICACIÓN', 'CAMA', 'HC', 'PACIENTE', 'EDAD', 
          'INGRESO', 'DH', 'DIAGNÓSTICO', 'ADJUNTO', 'PLAN'
        ];
        
        let data = [];
        
        if (service) {
          // PDF para un servicio específico (panel admin)
          data = allPatients[service].map(p => [
            p.location || '-', 
            p.bed || '-', 
            p.record || '-', 
            p.patient || '-', 
            p.age || '-',
            p.admission || '-', 
            p.dh || '-', 
            p.diagnosis || '-', 
            p.attachment || '-', 
            p.plan || '-'
          ]);
        } else {
          // PDF normal (panel médico)
          data = patients.map(p => [
            p.location || '-', 
            p.bed || '-', 
            p.record || '-', 
            p.patient || '-', 
            p.age || '-',
            p.admission || '-', 
            p.dh || '-', 
            p.diagnosis || '-', 
            p.attachment || '-', 
            p.plan || '-'
          ]);
        }
        
        doc.autoTable({
          head: [headers],
          body: data,
          startY: logoMarginTop + 25,
          margin: { left: margin, right: margin },
          styles: { 
            fontSize: 7,
            cellPadding: 2,
            overflow: 'linebreak',
            halign: 'center',
            valign: 'middle',
            textColor: [0, 0, 0],
            cellWidth: 'wrap',
            lineColor: [200, 200, 200],
            lineWidth: 0.2
          },
          headStyles: { 
            fillColor: [67, 97, 238],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle',
            lineWidth: 0.3,
            lineColor: [100, 100, 100]
          },
          bodyStyles: {
            halign: 'center',
            valign: 'middle',
            lineWidth: 0.2
          },
          alternateRowStyles: {
            fillColor: [250, 250, 250]
          },
          columnStyles: {
            0: { cellWidth: 'auto' },
            1: { cellWidth: 'auto' },
            2: { cellWidth: 'auto' },
            3: { cellWidth: 'auto' },
            4: { cellWidth: 'auto' },
            5: { cellWidth: 'auto' },
            6: { cellWidth: 'auto' },
            7: { cellWidth: 25 },
            8: { cellWidth: 'auto' },
            9: { cellWidth: 25 }
          },
          didDrawPage: function(data) {
            // Pie de página
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.text(`Página ${data.pageNumber}`, centerX, doc.internal.pageSize.getHeight() - 5, { align: 'center' });
          }
        });
        
        return doc;
      } catch (error) {
        console.error('Error al generar PDF:', error);
        showNotification('Error al generar PDF', 'error');
        return null;
      }
    }

    // Exportar a Excel
    function exportToExcel(service = null) {
      try {
        let data = [];
        const headers = [
          'Ubicación', 'Cama', 'HC', 'Paciente', 'Edad', 
          'Ingreso', 'DH', 'Diagnóstico', 'Adjunto', 'Plan'
        ];
        
        if (service) {
          // Datos para un servicio específico (panel admin)
          data = allPatients[service].map(p => [
            p.location || '-', 
            p.bed || '-', 
            p.record || '-', 
            p.patient || '-', 
            p.age || '-',
            p.admission || '-', 
            p.dh || '-', 
            p.diagnosis || '-', 
            p.attachment || '-', 
            p.plan || '-'
          ]);
        } else {
          // Datos normales (panel médico)
          data = patients.map(p => [
            p.location || '-', 
            p.bed || '-', 
            p.record || '-', 
            p.patient || '-', 
            p.age || '-',
            p.admission || '-', 
            p.dh || '-', 
            p.diagnosis || '-', 
            p.attachment || '-', 
            p.plan || '-'
          ]);
        }
        
        // Crear libro de trabajo
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        
        // Añadir hoja al libro
        XLSX.utils.book_append_sheet(wb, ws, "Pacientes");
        
        // Generar archivo
        const fileName = `pacientes_${service || currentService}_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showNotification('Archivo Excel generado correctamente');
      } catch (error) {
        console.error('Error al exportar a Excel:', error);
        showNotification('Error al exportar a Excel', 'error');
      }
    }

    // Cargar jsPDF dinámicamente si es necesario
    function loadJsPDF() {
      return new Promise((resolve, reject) => {
        if (window.jspdf) return resolve(window.jspdf);
        
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => resolve(window.jspdf);
        script.onerror = () => reject(new Error('Error al cargar jsPDF'));
        document.head.appendChild(script);
      });
    }

    // Compartir PDF
    async function sharePDF(service, shareMethod) {
      try {
        const activeService = document.querySelector('.service-tab.active')?.dataset.service || currentService;
        const patientsToShare = service ? allPatients[activeService] : patients;
        
        if (!patientsToShare || patientsToShare.length === 0) {
          showNotification('No hay pacientes para compartir', 'error');
          return;
        }
        
        const doc = await generatePDF(service ? activeService : null);
        if (!doc) return;
        
        const pdfBlob = doc.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        const fileName = `pacientes_${new Date().toISOString().slice(0,10)}.pdf`;
        const message = `Lista de pacientes - ${config.headerLine2}`;
        
        // Función para formatear los datos del paciente en el orden solicitado
        function formatPatientData(p) {
          return `
Ubicación: ${p.location || '-'}
Cama: ${p.bed || '-'}
HC: ${p.record || '-'}
Paciente: ${p.patient || '-'}
Edad: ${p.age || '-'}
Fecha de ingreso: ${p.admission || '-'}
DH: ${p.dh || '-'}
Diagnóstico: ${p.diagnosis || '-'}
Adjunto: ${p.attachment || '-'}
Plan: ${p.plan || '-'}
------------------------------`;
        }
        
        switch(shareMethod) {
          case 'whatsapp':
            let whatsappMsg = `*${config.headerLine1.toUpperCase()}*\n`;
            whatsappMsg += `*${config.headerLine2.toUpperCase()}*\n`;
            whatsappMsg += `*${config.headerLine3.toUpperCase()}*\n`;
            if (config.headerLine4) {
              whatsappMsg += `*${config.headerLine4.toUpperCase()}*\n\n`;
            }
            whatsappMsg += `*REVISTA DE PACIENTES*\n\n`;
            
            patientsToShare.forEach((p, i) => {
              whatsappMsg += `*PACIENTE ${i+1}*\n`;
              whatsappMsg += formatPatientData(p);
              whatsappMsg += `\n\n`;
            });
            
            whatsappMsg += `\n*Total pacientes: ${patientsToShare.length}*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(whatsappMsg)}`, '_blank');
            break;
            
          case 'telegram':
            let telegramMsg = `${config.headerLine1.toUpperCase()}\n`;
            telegramMsg += `${config.headerLine2.toUpperCase()}\n`;
            telegramMsg += `${config.headerLine3.toUpperCase()}\n`;
            if (config.headerLine4) {
              telegramMsg += `${config.headerLine4.toUpperCase()}\n\n`;
            }
            telegramMsg += `REVISTA DE PACIENTES\n\n`;
            
            patientsToShare.forEach((p, i) => {
              telegramMsg += `PACIENTE ${i+1}\n`;
              telegramMsg += formatPatientData(p);
              telegramMsg += `\n\n`;
            });
            
            telegramMsg += `\nTotal pacientes: ${patientsToShare.length}`;
            
            // Descargar el PDF primero
            downloadFile(pdfUrl, fileName);
            
            // Abrir Telegram con el mensaje formateado
            window.open(`https://t.me/share/url?url=${encodeURIComponent(pdfUrl)}&text=${encodeURIComponent(telegramMsg)}`, '_blank');
            break;
            
          case 'email':
            const subject = `Lista de Pacientes - ${config.headerLine2}`;
            let body = `Adjunto encontrarás la lista de pacientes actualizada.\n\n`;
            body += `${config.headerLine1}\n${config.headerLine2}\n${config.headerLine3}\n`;
            if (config.headerLine4) {
              body += `${config.headerLine4}\n\n`;
            }
            body += `DETALLE DE PACIENTES:\n\n`;
            
            patientsToShare.forEach((p, i) => {
              body += `PACIENTE ${i+1}\n`;
              body += formatPatientData(p);
              body += `\n\n`;
            });
            
            body += `\nTotal pacientes: ${patientsToShare.length}`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}&attachment=${encodeURIComponent(pdfUrl)}`;
            window.location.href = mailtoLink;
            break;
        }
      } catch (error) {
        console.error('Error al compartir:', error);
        showNotification('Error al compartir', 'error');
      }
    }

    // Descargar archivo
    function downloadFile(url, fileName) {
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Guardar datos de sesión en localStorage
    function saveSessionData(email, password, remember) {
      if (remember) {
        localStorage.setItem('hospital_email', email);
        localStorage.setItem('hospital_password', password);
        localStorage.setItem('hospital_remember', 'true');
      } else {
        localStorage.removeItem('hospital_email');
        localStorage.removeItem('hospital_password');
        localStorage.removeItem('hospital_remember');
      }
    }

    // Cargar datos de sesión desde localStorage
    function loadSessionData() {
      const remember = localStorage.getItem('hospital_remember') === 'true';
      if (remember) {
        emailInput.value = localStorage.getItem('hospital_email') || '';
        passwordInput.value = localStorage.getItem('hospital_password') || '';
        rememberMeCheckbox.checked = true;
      }
    }

    // Cambiar tema
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Actualizar icono
      const icon = themeToggle.querySelector('i');
      icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    // Registrar nuevo médico desde panel administrativo
    async function registerDoctorFromAdmin() {
      const email = adminRegisterEmail.value;
      const password = adminRegisterPassword.value;
      const service = adminRegisterService.value;
      const doctorId = adminRegisterBtn.dataset.doctorId;
      
      if (!email || !service || (!doctorId && !password)) {
        showNotification('Complete todos los campos', 'error');
        return;
      }
      
      if (!doctorId && password.length < 6) {
        showNotification('La contraseña debe tener al menos 6 caracteres', 'error');
        return;
      }
      
      try {
        if (doctorId) {
          // Actualizar médico existente
          await db.collection('users').doc(doctorId).update({
            email:
      email,
      phone: document.getElementById('admin-register-phone').value, email,
            services: [service],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          showNotification('Médico actualizado exitosamente');
          
          // Limpiar formulario
          adminRegisterEmail.value = '';
          adminRegisterPassword.value = '';
          adminRegisterService.value = '';
          adminRegisterBtn.innerHTML = '<i class="fas fa-save"></i> Registrar Médico';
          delete adminRegisterBtn.dataset.doctorId;
        } else {
          // Crear nuevo médico
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // Guardar información adicional en Firestore
          await db.collection('users').doc(user.uid).set({
            email: user.email,
      phone: document.getElementById('admin-register-phone').value,
            services: [service],
            isAdmin: false,
            disabled: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          showNotification('Médico registrado exitosamente');
          
          // Limpiar formulario
          adminRegisterEmail.value = '';
          adminRegisterPassword.value = '';
          adminRegisterService.value = '';
        }
        
        // Actualizar lista de médicos
        await loadDoctors();
        
      } catch (error) {
        console.error('Error al registrar médico:', error);
        showNotification('Error al registrar médico: ' + error.message, 'error');
      }
    }

    // Event Listeners
    headerLine1.addEventListener('input', saveConfig);
    headerLine2.addEventListener('input', saveConfig);
    headerLine3.addEventListener('input', saveConfig);
    headerLine4.addEventListener('input', saveConfig);

    leftLogoInput.addEventListener('change', () => {
      handleImageUpload(leftLogoInput, leftLogoPreview, 'leftLogo');
    });

    rightLogoInput.addEventListener('change', () => {
      handleImageUpload(rightLogoInput, rightLogoPreview, 'rightLogo');
    });

    // Búsqueda
    searchInput.addEventListener('input', (e) => {
      const filtered = filterPatients(e.target.value);
      renderTable(filtered);
    });

    addBtn.addEventListener('click', async () => {
      if (!patientForm.checkValidity()) {
        showNotification('Complete todos los campos', 'error');
        return patientForm.reportValidity();
      }
      
      const patientData = getFormData();
      
      try {
        if (editingIndex !== null) {
          // Actualizar paciente existente
          const patientId = currentPatientId;
          await db.collection('services').doc(currentService).collection('patients').doc(patientId).update(patientData);
          
          // Actualizar la lista de pacientes
          if (isAdmin) {
            await loadAllPatients();
          } else {
            await loadPatients();
          }
          
          editingIndex = null;
          currentPatientId = null;
          addBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar';
          showNotification('Paciente actualizado');
        } else {
          // Agregar nuevo paciente
          const docRef = await db.collection('services').doc(currentService).collection('patients').add(patientData);
          patients.unshift({ ...patientData, id: docRef.id });
          showNotification('Paciente agregado');
        }
        
        renderTable();
        patientForm.reset();
        
        // Restablecer fecha actual
        const now = new Date();
        const offset = now.getTimezoneOffset();
        now.setMinutes(now.getMinutes() - offset);
        document.getElementById('admission').value = now.toISOString().slice(0, 16);
        
      } catch (error) {
        console.error('Error al guardar paciente:', error);
        showNotification('Error al guardar paciente', 'error');
      }
    });

    pdfBtn.addEventListener('click', async () => {
      if (patients.length === 0) {
        showNotification('No hay pacientes para exportar', 'error');
        return;
      }
      
      const doc = await generatePDF();
      if (doc) {
        doc.save(`pacientes_${new Date().toISOString().slice(0,10)}.pdf`);
        showNotification('PDF descargado correctamente');
      }
    });

    excelBtn.addEventListener('click', () => {
      if (patients.length === 0) {
        showNotification('No hay pacientes para exportar', 'error');
        return;
      }
      
      exportToExcel();
    });

    previewBtn.addEventListener('click', async () => {
      if (patients.length === 0) {
        showNotification('No hay pacientes para previsualizar', 'error');
        return;
      }
      
      const doc = await generatePDF();
      if (doc) {
        const pdfUrl = doc.output('datauristring');
        const previewWindow = window.open('', '_blank');
        if (previewWindow) {
          previewWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>Vista Previa PDF</title>
              <style>
                body { margin: 0; padding: 0; }
                iframe { width: 100%; height: 100vh; border: none; }
              </style>
            </head>
            <body>
              <iframe src="${pdfUrl}"></iframe>
            </body>
            </html>
          `);
          previewWindow.document.close();
        } else {
          showNotification('Permite ventanas emergentes para ver la vista previa', 'error');
        }
      }
    });

    adminPdfBtn.addEventListener('click', async () => {
      const activeService = document.querySelector('.service-tab.active')?.dataset.service;
      if (!activeService || !allPatients[activeService] || allPatients[activeService].length === 0) {
        showNotification('No hay pacientes para exportar', 'error');
        return;
      }
      
      const doc = await generatePDF(activeService);
      if (doc) {
        doc.save(`pacientes_${activeService}_${new Date().toISOString().slice(0,10)}.pdf`);
        showNotification('PDF descargado correctamente');
      }
    });

    adminExcelBtn.addEventListener('click', () => {
      const activeService = document.querySelector('.service-tab.active')?.dataset.service;
      if (!activeService || !allPatients[activeService] || allPatients[activeService].length === 0) {
        showNotification('No hay pacientes para exportar', 'error');
        return;
      }
      
      exportToExcel(activeService);
    });

    adminPreviewBtn.addEventListener('click', async () => {
      const activeService = document.querySelector('.service-tab.active')?.dataset.service;
      if (!activeService || !allPatients[activeService] || allPatients[activeService].length === 0) {
        showNotification('No hay pacientes para previsualizar', 'error');
        return;
      }
      
      const doc = await generatePDF(activeService);
      if (doc) {
        const pdfUrl = doc.output('datauristring');
        const previewWindow = window.open('', '_blank');
        if (previewWindow) {
          previewWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>Vista Previa PDF</title>
              <style>
                body { margin: 0; padding: 0; }
                iframe { width: 100%; height: 100vh; border: none; }
              </style>
            </head>
            <body>
              <iframe src="${pdfUrl}"></iframe>
            </body>
            </html>
          `);
          previewWindow.document.close();
        } else {
          showNotification('Permite ventanas emergentes para ver la vista previa', 'error');
        }
      }
    });

    clearBtn.addEventListener('click', async () => {
      if (patients.length === 0) {
        showNotification('No hay pacientes para eliminar', 'error');
        return;
      }
      
      if (confirm('¿Eliminar TODOS los pacientes? Esta acción no se puede deshacer.')) {
        try {
          // Eliminar todos los pacientes de Firestore
          const snapshot = await db.collection('services').doc(currentService).collection('patients').get();
          const batch = db.batch();
          snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          
          patients = [];
          renderTable();
          showNotification('Todos los pacientes fueron eliminados');
        } catch (error) {
          console.error('Error al eliminar pacientes:', error);
          showNotification('Error al eliminar pacientes', 'error');
        }
      }
    });

    // Funciones globales
    window.editPatient = function(index) {
      const patient = patients[index];
      currentPatientId = patient.id;
      
      document.getElementById('location').value = patient.location;
      document.getElementById('bed').value = patient.bed;
      document.getElementById('record').value = patient.record;
      document.getElementById('patient').value = patient.patient;
      document.getElementById('age').value = patient.age;
      document.getElementById('dh').value = patient.dh;
      document.getElementById('diagnosis').value = patient.diagnosis;
      document.getElementById('attachment').value = patient.attachment;
      document.getElementById('plan').value = patient.plan;
      
      // Convertir fecha al formato correcto
      if (patient.admission) {
        const dateParts = patient.admission.split(/[\s/,:]+/);
        if (dateParts.length >= 5) {
          const dateStr = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T${dateParts[3]}:${dateParts[4]}`;
          document.getElementById('admission').value = dateStr;
        }
      }
      
      editingIndex = index;
      addBtn.innerHTML = '<i class="fas fa-save"></i> Guardar';
      
      patientForm.scrollIntoView({ behavior: 'smooth' });
    };

    window.deletePatient = async function(index) {
      if (confirm('¿Eliminar este paciente?')) {
        try {
          const patientId = patients[index].id;
          await db.collection('services').doc(currentService).collection('patients').doc(patientId).delete();
          
          patients.splice(index, 1);
          renderTable();
          showNotification('Paciente eliminado');
        } catch (error) {
          console.error('Error al eliminar paciente:', error);
          showNotification('Error al eliminar paciente', 'error');
        }
      }
    };

    window.editPatientAdmin = async function(service, index) {
      const patient = allPatients[service][index];
      
      try {
        // Cargar el servicio correspondiente
        currentService = service;
        await loadConfig(service);
        
        // Llenar el formulario con los datos del paciente
        document.getElementById('location').value = patient.location;
        document.getElementById('bed').value = patient.bed;
        document.getElementById('record').value = patient.record;
        document.getElementById('patient').value = patient.patient;
        document.getElementById('age').value = patient.age;
        document.getElementById('dh').value = patient.dh;
        document.getElementById('diagnosis').value = patient.diagnosis;
        document.getElementById('attachment').value = patient.attachment;
        document.getElementById('plan').value = patient.plan;
        
        // Convertir fecha al formato correcto
        if (patient.admission) {
          const dateParts = patient.admission.split(/[\s/,:]+/);
          if (dateParts.length >= 5) {
            const dateStr = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T${dateParts[3]}:${dateParts[4]}`;
            document.getElementById('admission').value = dateStr;
          }
        }
        
        currentPatientId = patient.id;
        editingIndex = index;
        addBtn.innerHTML = '<i class="fas fa-save"></i> Guardar';
        
        // Cambiar al panel médico
        adminContainer.classList.add('hidden');
        mainContainer.classList.remove('hidden');
        
        patientForm.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Error al editar paciente:', error);
        showNotification('Error al editar paciente', 'error');
      }
    };

    window.deletePatientAdmin = async function(service, index) {
      if (confirm('¿Eliminar este paciente?')) {
        try {
          const patientId = allPatients[service][index].id;
          await db.collection('services').doc(service).collection('patients').doc(patientId).delete();
          
          allPatients[service].splice(index, 1);
          renderAdminContent();
          renderAdminDashboard();
          showNotification('Paciente eliminado');
        } catch (error) {
          console.error('Error al eliminar paciente:', error);
          showNotification('Error al eliminar paciente', 'error');
        }
      }
    };

    // Sistema de autenticación
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const remember = rememberMeCheckbox.checked;
      
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Guardar datos de sesión si el usuario lo desea
        saveSessionData(email, password, remember);
        
        // Verificar si es administrador
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if (adminDoc.exists) {
          // Es administrador
          isAdmin = true;
          adminCurrentUserSpan.textContent = `Usuario: ${user.email}`;
          
          // Configurar observador de cambios
          setupPatientsObserver();
          await loadAllPatients();
          await loadDoctors();
          
          // Mostrar panel de administración
          loginContainer.classList.add('hidden');
          mainContainer.classList.add('hidden');
          adminContainer.classList.remove('hidden');
        } else {
          // Verificar si es médico normal
          const medicoDoc = await db.collection('users').doc(user.uid).get();
          if (!medicoDoc.exists) {
            await auth.signOut();
            showNotification('Usuario no registrado', 'error');
            return;
          }
          
          const userData = medicoDoc.data();
          
          // Es médico normal
          isAdmin = false;
          
          // Obtener el primer servicio del médico (en este diseño simplificado)
          currentService = userData.services[0];
          
          // Inicio de sesión exitoso
          currentUserSpan.textContent = `Usuario: ${user.email}`;
          currentServiceSpan.textContent = `Servicio: ${currentService}`;
          
          // Configurar observador de cambios
          setupServiceObserver();
          await loadConfig(currentService);
          await loadPatients();
          
          // Mostrar interfaz principal
          loginContainer.classList.add('hidden');
          mainContainer.classList.remove('hidden');
          
          // Iniciar carrusel
          startCarousel();
        }
        
        // Establecer fecha actual
        const now = new Date();
        const offset = now.getTimezoneOffset();
        now.setMinutes(now.getMinutes() - offset);
        document.getElementById('admission').value = now.toISOString().slice(0, 16);
        
      } catch (error) {
        console.error('Error de autenticación:', error);
        showNotification('Error de autenticación: ' + error.message, 'error');
      }
    });

    // Mostrar modal de login de administrador
    adminLoginBtn.addEventListener('click', () => {
      adminLoginModal.style.display = 'flex';
    });

    // Cerrar modal
    closeModalBtn.addEventListener('click', () => {
      adminLoginModal.style.display = 'none';
    });

    cancelAdminLoginBtn.addEventListener('click', () => {
      adminLoginModal.style.display = 'none';
    });

    // Login de administrador desde modal
    confirmAdminLoginBtn.addEventListener('click', async () => {
      const email = adminEmailInput.value;
      const password = adminPasswordInput.value;
      
      if (!email || !password) {
        showNotification('Ingrese correo y contraseña', 'error');
        return;
      }
      
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Verificar si es administrador
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if (!adminDoc.exists) {
          await auth.signOut();
          showNotification('No tiene permisos de administrador', 'error');
          return;
        }
        
        // Es administrador
        isAdmin = true;
        adminCurrentUserSpan.textContent = `Usuario: ${user.email}`;
        
        // Configurar observador de cambios
        setupPatientsObserver();
        await loadAllPatients();
        await loadDoctors();
        
        // Mostrar panel de administración
        loginContainer.classList.add('hidden');
        mainContainer.classList.add('hidden');
        adminContainer.classList.remove('hidden');
        adminLoginModal.style.display = 'none';
        
      } catch (error) {
        console.error('Error de autenticación:', error);
        showNotification('Error de autenticación: ' + error.message, 'error');
      }
    });

    // Configurar observador de cambios para el servicio actual (médicos)
    function setupServiceObserver() {
      return db.collection('services').doc(currentService).collection('patients')
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added' || change.type === 'modified') {
              loadPatients();
            } else if (change.type === 'removed') {
              loadPatients();
            }
          });
        });
    }

    // Configurar observador de cambios para todos los servicios (admin)
    function setupPatientsObserver() {
      services.forEach(service => {
        db.collection('services').doc(service).collection('patients')
          .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
              if (change.type === 'added' || change.type === 'modified' || change.type === 'removed') {
                loadAllPatients();
              }
            });
          });
      });
    }

    // Registrar nuevo médico desde panel administrativo
    adminRegisterBtn.addEventListener('click', registerDoctorFromAdmin);

    // Cerrar sesión
    logoutBtn.addEventListener('click', async () => {
      try {
        clearInterval(carouselInterval);
        await auth.signOut();
        loginContainer.classList.remove('hidden');
        mainContainer.classList.add('hidden');
        loginForm.reset();
        patients = [];
        renderTable();
        isAdmin = false;
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
      }
    });

    // Cerrar sesión admin
    adminLogoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
        loginContainer.classList.remove('hidden');
        adminContainer.classList.add('hidden');
        loginForm.reset();
        allPatients = {};
        isAdmin = false;
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
      }
    });

    // Cerrar modal de médicos
    closeDoctorsModalBtn.addEventListener('click', () => {
      doctorsModal.style.display = 'none';
    });

    // Cerrar modal de pacientes
    closePatientsModalBtn.addEventListener('click', () => {
      patientsModal.style.display = 'none';
    });

    // Cerrar modal de servicios
    closeServicesModalBtn.addEventListener('click', () => {
      servicesModal.style.display = 'none';
    });

    // Compartir por WhatsApp
    document.getElementById('share-whatsapp').addEventListener('click', () => {
      sharePDF(false, 'whatsapp');
    });

    // Compartir por Telegram
    document.getElementById('share-telegram').addEventListener('click', () => {
      sharePDF(false, 'telegram');
    });

    // Compartir por Email
    document.getElementById('share-email').addEventListener('click', () => {
      sharePDF(false, 'email');
    });

    // Compartir por WhatsApp (admin)
    document.getElementById('admin-share-whatsapp').addEventListener('click', () => {
      sharePDF(true, 'whatsapp');
    });

    // Compartir por Telegram (admin)
    document.getElementById('admin-share-telegram').addEventListener('click', () => {
      sharePDF(true, 'telegram');
    });

    // Compartir por Email (admin)
    document.getElementById('admin-share-email').addEventListener('click', () => {
      sharePDF(true, 'email');
    });

    // Cambiar tema
    themeToggle.addEventListener('click', toggleTheme);

    // Observador de estado de autenticación
    auth.onAuthStateChanged(user => {
      if (user) {
        // Usuario autenticado
        currentUserSpan.textContent = `Usuario: ${user.email}`;
        adminCurrentUserSpan.textContent = `Usuario: ${user.email}`;
        
        // Verificar si es administrador
        db.collection('admins').doc(user.uid).get().then(adminDoc => {
          if (adminDoc.exists) {
            // Es administrador
            isAdmin = true;
            loadAllPatients();
            loadDoctors();
            loginContainer.classList.add('hidden');
            adminContainer.classList.remove('hidden');
          } else {
            // Verificar si es médico normal
            db.collection('users').doc(user.uid).get().then(medicoDoc => {
              if (medicoDoc.exists) {
                // Cargar datos de sesión guardados
                const userData = medicoDoc.data();
                currentService = userData.services[0];
                currentUserSpan.textContent = `Usuario: ${user.email}`;
                currentServiceSpan.textContent = `Servicio: ${currentService}`;
                loadConfig(currentService);
                loadPatients();
                loginContainer.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                
                // Iniciar carrusel
                startCarousel();
              } else {
                // Usuario no registrado
                auth.signOut();
              }
            });
          }
        });
      } else {
        // Usuario no autenticado
        loginContainer.classList.remove('hidden');
        mainContainer.classList.add('hidden');
        adminContainer.classList.add('hidden');
      }
    });

    // Iniciar aplicación
    document.addEventListener('DOMContentLoaded', () => {
      // Cargar datos de sesión guardados
      loadSessionData();
      
      // Cargar tema preferido
      const savedTheme = localStorage.getItem('theme') || 
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      // Actualizar icono del botón de tema
      const icon = themeToggle.querySelector('i');
      icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      
      // Establecer fecha actual
      const now = new Date();
      const offset = now.getTimezoneOffset();
      now.setMinutes(now.getMinutes() - offset);
      document.getElementById('admission').value = now.toISOString().slice(0, 16);
    });
  </script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const wordBtn = document.getElementById('admin-word-btn');
  if (!wordBtn) return;

  wordBtn.addEventListener('click', () => {
    const activeTab = document.querySelector('.service-tab.active');
    const activeService = activeTab ? activeTab.textContent.trim().split('\n')[0] : 'SIN SERVICIO';
    const activeContent = document.querySelector('.service-content.active');
    if (!activeContent) {
      alert("No hay contenido activo para exportar.");
      return;
    }

    const tableHTML = activeContent.innerHTML;
    const header = `
      <html xmlns:o='urn:schemas-microsoft-com:office:office'
            xmlns:w='urn:schemas-microsoft-com:office:word'
            xmlns='http://www.w3.org/TR/REC-html40'>
      <head>
        <meta charset='utf-8'>
        <title>Documento Word</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; }
          h1, h2, h3 { text-align: center; margin: 5px 0; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 12px; }
          .header-info { margin-top: 10px; text-align: center; font-size: 12px; }
        </style>
      </head>
      <body>
        <h3>REPÚBLICA BOLIVARIANA DE VENEZUELA</h3>
        <h2>HOSPITAL IVSS "DR. PATROCINIO PEÑUELA RUIZ"</h2>
        <h3>SAN CRISTÓBAL, ESTADO TÁCHIRA</h3>
        <div class="header-info">Generado: ${new Date().toLocaleString()}</div>
    `;
    const footer = `<br><br><div><strong>${activeService}</strong></div></body></html>`;
    const fullHTML = header + tableHTML + footer;

    const blob = new Blob([fullHTML], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "pacientes.doc";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });
});
</script></body>
</html>